# 狼人杀游戏更新日志

## 2025 年 1 月 26 日 - 中文狼人杀规则实现

### 新增功能

#### 1. 夜晚行动顺序调整

- **新顺序**：守卫 → 狼人 → 预言家 → 女巫
- **旧顺序**：狼人 → 守卫 → 预言家 → 女巫
- 符合中国狼人杀标准规则

#### 2. 胜利条件修改

- **6 人局**：狼人需要杀光**所有平民和所有神职**才能获胜
- **9 人/12 人局**：狼人杀光**所有平民或所有神职**即可获胜
- **好人阵营**：所有局数统一为杀光所有狼人获胜

#### 3. 猎人技能

- 猎人被杀时可以开枪带走一名玩家
- **例外**：被女巫毒杀时不能开枪
- 支持 9 人局和 12 人局（6 人局无猎人）

#### 4. 遗言系统

- **夜晚死亡**：第一晚被狼人杀害的玩家可以发表遗言
- **白天死亡**：被投票出局的玩家可以发表遗言
- 遗言由 AI 生成，符合角色身份和游戏情况

#### 5. 死亡记录追踪

- 新增`death_records`字段记录每个玩家的死因
- 死因类型：
  - `werewolf_kill` - 被狼人杀害
  - `witch_poison` - 被女巫毒杀
  - `voted_out` - 被投票出局
  - `hunter_shot` - 被猎人开枪带走

### 游戏流程优化

#### 6. 讨论轮数固定

- 每轮白天阶段只有**1 轮讨论**（硬编码）
- 简化游戏流程，加快游戏速度

#### 7. 实时日志系统

- 游戏进行中实时写入日志文件
- 每条消息立即追加到文件，不等游戏结束
- 日志文件保存在专门的`game_logs/`文件夹
- 文件命名格式：`werewolf_game_YYYYMMDD_HHMMSS.txt`

#### 8. 完整对话记录

- **移除讨论截断**：不再限制发言字数（之前限制为 100 字符）
- 完整记录所有玩家的讨论内容
- 保留游戏的完整对话历史

### 技术改进

#### 代码结构

- `werewolf/WerewolfGame.py`：

  - 添加`death_records`到`GameState`
  - 更新`check_game_end()`胜利判定逻辑
  - 在`execute_night_phase()`和`execute_day_phase()`中记录死因

- `werewolf/orchestrator.py`：

  - 重构`_run_night_phase()`夜晚行动顺序
  - 固定`discussion_rounds = 1`
  - 实现`_write_to_log_file()`实时日志写入
  - 添加遗言和猎人开枪逻辑
  - 创建`game_logs/`目录

- `werewolf/agents.py`：

  - 添加`last_words()`方法到基类
  - 实现完整的`HunterAgent`类
  - 更新`create_agent()`工厂函数

- `run_game.py`：
  - 简化参数传递
  - 使用`orchestrator.log_file`获取日志路径

#### 测试更新

- 更新`tests/test_werewolf_game.py`：
  - 新增 6 人局胜利条件测试
  - 新增 9 人/12 人局分别测试平民和神职阵亡
  - 新增死亡记录追踪测试
  - 新增猎人角色存在性测试
  - **所有 33 个测试通过** ✅

### 文件组织

- 日志文件统一存放在`game_logs/`文件夹
- 添加`.gitignore`规则忽略日志文件：
  ```
  # Game logs
  game_logs/
  werewolf_game_*.txt
  ```

### 兼容性

- Python 3.10.11
- AgentScope 1.0.6
- ModelScope API (Qwen/Qwen2.5-72B-Instruct)
- 所有现有功能保持向后兼容

### 已知限制

- 猎人开枪目标由 AI 选择（未来可考虑添加策略配置）
- 遗言长度由 AI 控制（未来可考虑添加长度限制）

---

## 下一步计划

- [ ] 添加更多测试用例覆盖猎人开枪场景
- [ ] 优化 AI 遗言生成质量
- [ ] 考虑添加游戏回放功能
- [ ] 性能优化：大规模游戏测试
